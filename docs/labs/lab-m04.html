<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Ben Falandays">

<title>Module 4 Lab: Model Evaluation and Comparison</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="lab-m04_files/libs/clipboard/clipboard.min.js"></script>
<script src="lab-m04_files/libs/quarto-html/quarto.js"></script>
<script src="lab-m04_files/libs/quarto-html/popper.min.js"></script>
<script src="lab-m04_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="lab-m04_files/libs/quarto-html/anchor.min.js"></script>
<link href="lab-m04_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="lab-m04_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="lab-m04_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="lab-m04_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="lab-m04_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="2">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#exercise-1" id="toc-exercise-1" class="nav-link" data-scroll-target="#exercise-1">Exercise 1</a></li>
  <li><a href="#exercise-2" id="toc-exercise-2" class="nav-link" data-scroll-target="#exercise-2">Exercise 2</a></li>
  <li><a href="#exercise-3" id="toc-exercise-3" class="nav-link" data-scroll-target="#exercise-3">Exercise 3</a></li>
  <li><a href="#exercise-4" id="toc-exercise-4" class="nav-link" data-scroll-target="#exercise-4">Exercise 4</a></li>
  <li><a href="#exercise-5" id="toc-exercise-5" class="nav-link" data-scroll-target="#exercise-5">Exercise 5</a></li>
  <li><a href="#exercise-6" id="toc-exercise-6" class="nav-link" data-scroll-target="#exercise-6">Exercise 6</a></li>
  <li><a href="#exercise-7" id="toc-exercise-7" class="nav-link" data-scroll-target="#exercise-7">Exercise 7</a></li>
  <li><a href="#exercise-8" id="toc-exercise-8" class="nav-link" data-scroll-target="#exercise-8">Exercise 8</a></li>
  <li><a href="#exercise-9" id="toc-exercise-9" class="nav-link" data-scroll-target="#exercise-9">Exercise 9</a></li>
  <li><a href="#exercise-10" id="toc-exercise-10" class="nav-link" data-scroll-target="#exercise-10">Exercise 10</a></li>
  <li><a href="#exercise-11" id="toc-exercise-11" class="nav-link" data-scroll-target="#exercise-11">Exercise 11</a></li>
  <li><a href="#exercise-12" id="toc-exercise-12" class="nav-link" data-scroll-target="#exercise-12">Exercise 12</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Module 4 Lab: Model Evaluation and Comparison</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Ben Falandays </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<section id="introduction" class="level1">
<h1>Introduction</h1>
<div class="callout callout-style-default callout-caution no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Learning Objectives
</div>
</div>
<div class="callout-body-container callout-body">
<p>Our learning objectives for this module are:</p>
<ul>
<li>Understand basic metrics of model fit, including accuracy, precision, recall, and AIC</li>
<li>Understand how model evaluation and comparison is used to select and tune models</li>
</ul>
</div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../imgs/babycow.jpeg" class="img-fluid figure-img" style="width:75.0%"></p>
<figcaption class="figure-caption">Please don’t eat me, Jane!</figcaption>
</figure>
</div>
<p>Imagine that Jane has made a moral commitment to not eating veal anymore, despite the fact that veal parmigiana is her favorite dish. She sits down at her favorite Italian restaurant and peruses the menu. Her eyes flit back and forth between her old favorite, veal parmigiana, and her new replacement, chicken parmigiana. She wants to adhere to her new moral code, but the veal is tempting. Just as her eyes happen to have settled on the veal for about 1 s, suddenly the waiter walks up and asks what she would like to order. If the waiter had shown up a second or two later, she might have managed to settle her eyes, and her mind, back on the chicken. But, in that moment, her decision is prompted and she caves, ordering the veal.</p>
<p>The dataset for this lab comes from an experiment in which we (Falandays, Spevack, Pärnamets, &amp; Spivey, 2021) tested the idea that decisions could be swayed by the timing of when one is asked for a response. In the experiment, participants heard moral questions, such as “Is murder ever justifiable?”, and non-moral questions, such as “Is Denmark larger than Sweden?” For each question, there were two possible response options, and participants were instructed to click on their preferred choice.</p>
<p>Unbeknownst to participants, the experiment software was trying to get them to choose one of the two options on each trial. For each question, one of the two responses was randomly designated as the “target” response, and the experimenters used an eye tracker to record the amount of time the participant spent looking at the target response, versus the other response. Only once the participant spent at least 750ms looking at the target option were they prompted to respond. The experimenters hypothesized that participants would be more likely to choose the target when (1) they spent more time looking at the target, relative to the other response, (2) the target was the <em>last</em> thing they looked at before being prompted to respond.</p>
<p>The variables in this dataset include:</p>
<ul>
<li><code>subj_id</code>: a unique identifier for each participant</li>
<li><code>trialnum</code>: an identifier for which trial each row corresponds to (in terms of order within the study)</li>
<li><code>Q_type</code>: whether the question was a moral or non-moral one</li>
<li><code>targ_loc</code>: whether the “target” response was on the left or right side of the screen</li>
<li><code>choice_loc</code>: whether the participant chose the response on the left or right side of the screen</li>
<li><code>RT</code>: reaction time</li>
<li><code>left_fixTime_ms</code>: time (in milliseconds) spent looking at the response option on the left side of the screen</li>
<li><code>right_fixTime_ms</code>: time (in milliseconds) spent looking at the response option on the right side of the screen</li>
<li><code>Q_id</code>: a unique identifier for each question</li>
<li><code>lastfix</code>: whether the participant looked at the left or right response option last (just before they were prompted to respond)</li>
<li><code>Q_text</code>: the text of question they heard</li>
<li><code>option1_text</code>: the text of the first response option</li>
<li><code>option2_text</code>: the text of the second response option</li>
</ul>
<p>Start by loading the key libraries and the dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"moralDecisions.Rdata"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="exercise-1" class="level1">
<h1>Exercise 1</h1>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise 1
</div>
</div>
<div class="callout-body-container callout-body">
<p>Our first goal will be to make a plot that shows…</p>
<ul>
<li>On the y-axis: whether or not the participant chose the target</li>
<li>On the x-axis: the time spent fixating the target, minus the time spent fixating the other option</li>
</ul>
<p>To do this, we will first need to make some new variables:</p>
<ol type="1">
<li>Make a new variable called <code>chose_targ</code>, which will be equal to 1 if the participant chose the target, or 0 otherwise</li>
</ol>
<ul>
<li>You will need to use <code>targ_loc</code> and <code>choice_loc</code> to make this variable</li>
</ul>
<ol start="2" type="1">
<li>Make two new variables, <code>targ_fixTime</code> and <code>nontarg_fixTime</code>, giving the time spent fixating the target or non-target, respectively.</li>
</ol>
<ul>
<li>You will need to use <code>left_fixTime_ms</code>, <code>right_fixTime_ms</code>, and <code>targ_loc</code></li>
</ul>
<ol start="3" type="1">
<li>Make a variable called <code>targ_fix_bias</code>, giving the time spent fixating the target <em>minus</em> the time spent fixating the non-target</li>
<li>Make a variable called <code>lastfix_item</code>, which identifies whether the last fixation before prompting was to the target or non-target</li>
</ol>
<ul>
<li>You will need to use <code>lastfix</code> and <code>targ_loc</code></li>
</ul>
<p>Once you have all the variables, set up your initial plot.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>You may want to jitter your points and adjust the alpha level to make all of the datapoints visible.</p>
</div>
</div>
</div>
</div>
</section>
<section id="exercise-2" class="level1">
<h1>Exercise 2</h1>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise 2
</div>
</div>
<div class="callout-body-container callout-body">
<p>So far, you’ve learned about three different models: linear regression, and naive Bayes, logistic regression. Which model(s) do you think would be appropriate for this dataset?</p>
<p>Once you’ve answered that question, use <code>geom_smooth()</code> to add smoothed conditional means to your plot. Set the <code>method</code> and <code>method.args</code> accordingly, depending upon which model type you think is most appropriate. Additionally, use different colors for each level of <code>Q_type</code> and different linetypes for each level of <code>lastfix_item</code>.</p>
</div>
</div>
</section>
<section id="exercise-3" class="level1">
<h1>Exercise 3</h1>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise 3
</div>
</div>
<div class="callout-body-container callout-body">
<p>Make your train/test split of the data. Rather than using <code>initial_split()</code>, use <code>group_initial_split()</code> with <code>group</code> set to <code>subj_id</code>. This will make sure that data from an individual subject stays together, and goes into <em>either</em> the test or the train split.</p>
</div>
</div>
</section>
<section id="exercise-4" class="level1">
<h1>Exercise 4</h1>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise 4
</div>
</div>
<div class="callout-body-container callout-body">
<p>Build one or more model specifications and workflows, depending upon which model(s) you think could be applied to this type of data. Our goal will be to predict whether, on each trial, the participant chose the target or the non-target.</p>
</div>
</div>
</section>
<section id="exercise-5" class="level1">
<h1>Exercise 5</h1>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise 5
</div>
</div>
<div class="callout-body-container callout-body">
<p>Fit one or more very simple model(s) to the training data, predicting <code>chose_targ</code> from just <code>lastfix_item</code>. Assess the performance on the training data by getting the balanced accuracy, F-measure, and ROC-AUC.</p>
</div>
</div>
</section>
<section id="exercise-6" class="level1">
<h1>Exercise 6</h1>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise 6
</div>
</div>
<div class="callout-body-container callout-body">
<p>Fit one or more complex model(s) to the training data, predicting <code>chose_targ</code> from <code>lastfix_item</code>, <code>targ_fix_bias</code> and <code>Q_type</code>. Assess the performance on the training data by getting the balanced accuracy, F-measure, and ROC-AUC.</p>
</div>
</div>
</section>
<section id="exercise-7" class="level1">
<h1>Exercise 7</h1>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise 7
</div>
</div>
<div class="callout-body-container callout-body">
<p>Based on your result above, which model do you think will do best on the test set? Evaluate all of your models on the test set and see if your expectations were correct.</p>
</div>
</div>
</section>
<section id="exercise-8" class="level1">
<h1>Exercise 8</h1>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise 8
</div>
</div>
<div class="callout-body-container callout-body">
<p>Next, let’s see if we can predict reaction times. As a first step, make a histogram of reaction times, with separate facets for each <code>Q_type</code></p>
</div>
</div>
</section>
<section id="exercise-9" class="level1">
<h1>Exercise 9</h1>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise 9
</div>
</div>
<div class="callout-body-container callout-body">
<p>Reaction times are not typically normally distributed, because they have a minimum at 0, and tend to have a long tail (a small number of trials with very long RTs). We can use a log transformation to try to make them closer to normal distribution, which will allow the data to fit the assumptions of our models.</p>
<p>Make a new variable, <code>logRT</code>, and plot the histograms again for that variable.</p>
</div>
</div>
</section>
<section id="exercise-10" class="level1">
<h1>Exercise 10</h1>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise 10
</div>
</div>
<div class="callout-body-container callout-body">
<p>Next, we’ll make three plots. In each case, the y-axis will be <code>logRT</code>, and the x-axes will be:</p>
<ol type="1">
<li><code>Q_type</code></li>
<li><code>chose_targ</code></li>
<li><code>trialnum</code></li>
</ol>
<p>Rather than plotting the raw data, plot the means for each level of the variable on the x-axis. You can do this in a few ways:</p>
<ul>
<li>Use <code>group_by()</code> and <code>summarise()</code> to get the means in a separate dataframe before plotting</li>
<li>In your plot, use <code>stat_summary()</code> instead of <code>geom_point()</code> (Tip: with <code>stat_summary</code>, set <code>group = 1</code> if you get an error about each group having only one observation)</li>
<li>In your plot, use <code>geom_smooth()</code> to plot smoothed conditional means.</li>
</ul>
</div>
</div>
</section>
<section id="exercise-11" class="level1">
<h1>Exercise 11</h1>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise 11
</div>
</div>
<div class="callout-body-container callout-body">
<p>What kind of model(s) that you’ve learned so far would be appropriate for predicting reaction time? Pick an appropriate model type and follow the same basic steps you did before:</p>
<ol type="1">
<li>Make the train/test split (we need to redo this, since we didn’t have <code>logRT</code> in our dataset before)</li>
<li>Make the model specification and workflow</li>
<li>Build one model predicting <code>logRT</code> from just <code>Q_type</code></li>
<li>Build a second model predicting <code>logRT</code> from <code>Q_type</code>, <code>chose_targ</code> and <code>trialnum</code></li>
<li>Pick appropriate metrics and evaluate your models on the training data. Which do you think will be best?</li>
<li>Evaluate your models on the test data. Was your guess correct?</li>
</ol>
</div>
</div>
</section>
<section id="exercise-12" class="level1">
<h1>Exercise 12</h1>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise 12
</div>
</div>
<div class="callout-body-container callout-body">
<p>Make one last model with all predictors from the previous model, but also include <code>subj_id</code> as a predictor.</p>
<ul>
<li>Does this model perform better or worse on the <strong>training</strong> set?</li>
<li>Does it perform better or worse on the <strong>test</strong> set? Why?</li>
</ul>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>